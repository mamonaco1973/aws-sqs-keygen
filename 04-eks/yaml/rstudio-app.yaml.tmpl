# ==============================================================================
# RStudio App - Combined Kubernetes Manifest (Secrets Mounted as Files)
# ------------------------------------------------------------------------------ 
# This manifest deploys an RStudio Server cluster into a Kubernetes environment
# configured for Active Directory (AD) authentication using SSSD.
#
# It defines:
#   1. A Secret containing configuration parameters (admin_secret, domain_fqdn, region)
#   2. A PersistentVolumeClaim backed by EFS for shared home directories
#   3. A StatefulSet for the RStudio container with Secret mounted as files
#   4. A Service for internal cluster access (ClusterIP)
#   5. A Headless Service for stable DNS and hostnames
#   6. An ALB Ingress for external access over HTTP
#   7. A Horizontal Pod Autoscaler (HPA) that scales based on CPU utilization
# ==============================================================================
# --- StorageClass for EFS (Static Provisioning) -------------------------------
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: efs.csi.aws.com
mountOptions:
  - tls
reclaimPolicy: Retain
volumeBindingMode: Immediate
allowVolumeExpansion: true
# Notes:
# - No 'parameters' block — this disables dynamic provisioning.
# - EFS PVs must be defined manually (static provisioning).

---
# --- PersistentVolume for EFS Filesystem -------------------------------------
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-pv
spec:
  capacity:
    storage: 1Ti
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sc
  mountOptions:
    - tls
  csi:
    driver: efs.csi.aws.com
    volumeHandle: ${efs_id}               # Replace with your actual EFS ID
---
# --- Secret: RStudio Configuration -------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: rstudio-config
type: Opaque
stringData:
  admin_secret: "${admin_secret}"
  domain_fqdn: "${domain_fqdn}"
  region: "us-east-1"
# Notes:
# - The values here are low sensitivity; credentials are stored in AWS Secrets Manager.
# - Mounted as text files inside the container (not environment variables).
---
# --- PersistentVolumeClaim (EFS) ---------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-claim
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-sc
  resources:
    requests:
      storage: 1Gi
# Notes:
# - Shared /home-style storage persisted in EFS.
# - Allows user home directories and R libraries to persist across pods.
---
# --- Headless Service for StatefulSet ----------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  clusterIP: None
  selector:
    app: rstudio
  ports:
    - port: 8787
      name: rstudio
# Notes:
# - Enables unique, stable hostnames like rstudio-0.rstudio.<namespace>.svc.
# - Required for StatefulSet hostname resolution and AD compatibility.
---
# --- StatefulSet --------------------------------------------------------------
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rstudio
  labels:
    app: rstudio
spec:
  serviceName: "rstudio"
  replicas: 2
  selector:
    matchLabels:
      app: rstudio
  template:
    metadata:
      labels:
        app: rstudio
    spec:
      # ------------------------------------------------------------------------
      # Service Account
      # ------------------------------------------------------------------------
      serviceAccountName: secrets-reader-sa
      # This service account should be IRSA-enabled (AWS IAM Role for Service Account)
      # so that the container can securely call AWS Secrets Manager APIs without
      # embedding static IAM credentials.

      # ------------------------------------------------------------------------
      # Container Specification
      # ------------------------------------------------------------------------
      containers:
      - name: rstudio
        image: ${rstudio_image}            # Injected at render time
        ports:
        - containerPort: 8787              # Default RStudio Server web interface port

        # ----------------------------------------------------------------------
        # Resource Requests & Limits
        # ----------------------------------------------------------------------
        resources:
          requests:
            cpu: "1200m"
            memory: "2500Mi"
          limits:
            cpu: "2000m"
            memory: "3500Mi"
        # Notes:
        # - Each t3.medium node fits one pod (2 vCPU, 4 GiB memory).
        # - Scale-out occurs when average CPU > 60% (see HPA below).

        # ----------------------------------------------------------------------
        # Secret Volume Mount (Configuration)
        # ----------------------------------------------------------------------
        volumeMounts:
        - name: rstudio-config-vol
          mountPath: /etc/rstudio-config
          readOnly: true

        # ----------------------------------------------------------------------
        # EFS Volume Mount (Persistent Home Directories)
        # ----------------------------------------------------------------------
        - name: efs-storage
          mountPath: /efs
        - name: efs-storage
          mountPath: /home
          subPath: home

      # ------------------------------------------------------------------------
      # Volumes
      # ------------------------------------------------------------------------
      volumes:
      - name: rstudio-config-vol
        secret:
          secretName: rstudio-config
          defaultMode: 0440
      - name: efs-storage
        persistentVolumeClaim:
          claimName: efs-claim
# Notes:
# - Each pod receives a stable, unique hostname (rstudio-0, rstudio-1, etc.).
# - NetBIOS truncation no longer causes hostname collisions in AD.
---
# --- Service ------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: rstudio-service
  labels:
    app: rstudio
spec:
  type: ClusterIP
  selector:
    app: rstudio
  ports:
  - port: 8787
    targetPort: 8787
# Notes:
# - Internal service used by the ALB ingress.
---
# --- Ingress ------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rstudio-ingress
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80}]'
    alb.ingress.kubernetes.io/healthcheck-path: /auth-sign-in
    alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=3600
    alb.ingress.kubernetes.io/target-group-attributes: >
      stickiness.enabled=true,
      stickiness.type=lb_cookie,
      stickiness.lb_cookie.duration_seconds=86400
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: rstudio-service
              port:
                number: 8787
# Notes:
# - Provisions an external ALB for access to RStudio.
# - Attach ACM certificate for HTTPS termination.
# - ExternalDNS can map ${domain_fqdn} to the ALB endpoint.
---
# --- Horizontal Pod Autoscaler (CPU-Based Scaling) ----------------------------
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: rstudio-hpa
  labels:
    app: rstudio
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: rstudio
  minReplicas: 2
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
# Notes:
# - HPA scales between 2–4 replicas based on CPU utilization.
# - Cluster Autoscaler provisions nodes if required.
# - StatefulSet ensures hostname stability and AD uniqueness.
# ==============================================================================
